#!/dev/null




<< publish / all / remote
	test "${#}" -eq 0
	"${ZRUN[@]}" ':: publish / hash / remote'
	"${ZRUN[@]}" ':: publish / push / remote'
!!


<< publish / all / local
	test "${#}" -eq 0
	"${ZRUN[@]}" ':: publish / hash / local'
	"${ZRUN[@]}" ':: publish / push / local'
!!




<< publish / hash / remote
	exec -- "${ZRUN[@]}" \
			--ssh \
			--ssh-target=covid19-datasets-publisher \
			--ssh-workspace=./workbench/covid19-datasets/ \
			':: publish / hash / local' \
			"${@}" \
	#
!!


<< publish / hash / local
	test "${#}" -eq 0
	# rm -f -- ./imports/.force
	rm -f -- ./imports/.md5 ./exports/.md5 ./plots/.md5
	md5-create -o ./imports/.md5 -- ./imports
	md5-create -o ./exports/.md5 -- ./exports
	md5-create -o ./plots/.md5 -- ./plots
	for _hashes in ./imports/.md5 ./exports/.md5 ./plots/.md5 ; do
		LC_ALL=C sort -k 2 -t ' ' \
			< "${_hashes}" \
			>| "${_hashes}.tmp" \
		#
		mv -f -T -- "${_hashes}.tmp" "${_hashes}"
	done
!!




<< publish / push / remote
	exec -- "${ZRUN[@]}" \
			--ssh \
			--ssh-target=covid19-datasets-publisher \
			--ssh-workspace=./workbench/covid19-datasets/ \
			':: publish / push / local' \
			"${@}" \
	#
!!


<< publish / push / local
	
	test "${#}" -eq 0
	
	test -d ./.publish
	
	exec -- \
		nice -n 19 -- \
	rsync \
			--recursive --one-file-system \
			--delete \
			--delete-excluded \
			--links \
			--times --omit-dir-times --omit-link-times \
			--prune-empty-dirs \
			--no-compress \
			\
			--exclude '*.tmp' \
			--exclude '*.tmp.*' \
			--exclude '*#' \
			--include '/imports/' \
			--exclude '/imports/.force' \
			--include '/imports/**' \
			--include '/exports/' \
			--include '/exports/**' \
			--include '/plots/' \
			--include '/plots/**' \
			--exclude '**' \
			\
			--filter 'P .restic.excluded' \
			\
			--itemize-changes \
			--protect-args --no-iconv \
			\
		-- \
			./ \
			./.publish/
	#
!!

